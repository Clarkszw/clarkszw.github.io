---
title: "NYCschool"
author: "Zhiwen Shi"
date: "2022-10-13"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

## NYC school

# Data cleaning

Import data

```{r}
D75S <-  read_tsv("masterfile11_d75_final.txt")
generalS <- read_tsv("masterfile11_gened_final.txt")
combined <- read_csv("combined.csv")
```


Simplify the survey dataframes to include only variables like dbn and variables that contain aggregate scores like saf_p_11 and com_s_11. 

Filter the survey dataframes to include only observations for high schools.

```{r }
d75_select <- D75S %>% 
  select(dbn:aca_tot_11)

general_select <- generalS %>% 
  select(dbn:aca_tot_11) %>% 
  filter(schooltype == 'High School')
```

Combine three dataframes.
Use `left_join()` to keep the observations in the survey dataframe that correspond to observations in combined.

```{r}
survey_total <- d75_select %>% 
  bind_rows(general_select) %>% 
  rename(DBN = dbn)

combined_survej <- combined %>% 
  left_join(survey_total, by = 'DBN')
```

Correlation to show if student, teacher, and parent perceptions of NYC school quality appear to be related to demographic and academic success metrics.

```{r}
cor_mat <- combined_survej %>% 
  select(avg_sat_score, contains('_11')) %>% 
  cor(use = 'pairwise.complete.obs')

cor_tib <- cor_mat %>% 
  as_tibble(rownames= 'variable')
```

Find strong correlations of other variables with `avg_sat_score` that are greater than 0.25 or less than -0.25 (strong correlations).

```{r}
strong_cors <- cor_tib %>%
  select(variable, avg_sat_score) %>%
  filter(avg_sat_score > 0.25 | avg_sat_score < -0.25)  
```

Create scatter plots to explore potentially interesting relationships between variables in greater detail. 

```{r}
strong_cors %>% 
  filter(variable != 'avg_sat_score') %>% 
  ggplot(aes(x = variable, y = avg_sat_score ))+
  geom_point()+
  labs(
    title= 'Strong correlation between average SAT score and servey varibles',
    x = 'Survey variables',
    y = 'Average SAT score'
  )
```

#Differences in Student, Parent, and Teacher Perceptions

reshape data to to long type.

```{r}
combined_survej_long <- combined_survej %>% 
  pivot_longer(cols = saf_p_11:aca_tot_11,
               names_to = 'survey_question',
               values_to = 'score')
```

Use `str_sub` to create new variables, `group` and `question`, from the `survey_question` variable.

```{r}
combined_survej_long <- combined_survej_long %>% 
  mutate(question = str_sub(survey_question,1,3)) %>% 
  mutate(group= str_sub(survey_question,4,6))
```

Use `case_when` to rename values in `group` and `question`.

```{r}
combined_survej_long <- combined_survej_long %>% 
  mutate(question = case_when(
    question == 'saf' ~ 'safety and respect',
    question == 'com' ~ 'communication',
    question == 'eng' ~ 'engagement',
    question == 'aca' ~ 'academic expectations',
    TRUE ~ 'NA'
  )) %>% 
  mutate(group= case_when(
    group == '_p_' ~ 'parent',
    group == '_t_' ~ 'teacher',
    group == '_s_' ~ 'student',
    group == '_to' ~ 'total',
    TRUE ~ 'NA'
  ))
```

Make a boxplot to see if there appears to be differences in how the three groups (parents, students, and teachers) answered the four questions. 

```{r}
combined_survej_long %>% 
  filter(group!='total') %>% 
  ggplot(aes(x = group, y = score, color=question))+
  geom_boxplot()


```

```{r}
combined_survej_long %>% 
  filter(group!='total') %>% 
  ggplot(aes(x = question, y = score, color=group))+
  geom_boxplot()
```

#remaining questions
* Is there a relationship between gender percentages and average SAT scores? How about for the different sections of the SAT (Reading, Writing, and Math)?

* Which NYC schools seem to have the best quality metrics according to survey data? Is there a difference if you break this down by response type?

* Can you learn anything from the differences in school quality metric perception between groups? For example, if you created a new variable by subtracting saf_p_11 from saf_s_11, do you think this difference in how students and parents perceive safety may be related to any other variables?
